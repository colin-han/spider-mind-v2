-- ============================================================================
-- 添加显式命名的唯一索引
-- ============================================================================
-- 问题: 文档要求显式命名的唯一索引，但实际仅依赖 UNIQUE 约束的隐式索引
-- 影响: 索引名称不可控，影响运维监控和文档一致性
-- 解决: 创建文档中定义的显式命名索引
-- ============================================================================

-- ============================================================================
-- 1. mindmaps 表: 添加 idx_mindmaps_user_short_id 索引
-- ============================================================================

-- 检查是否已存在显式索引（避免重复创建）
DO $$
BEGIN
  -- 删除约束隐式创建的索引（如果存在）
  -- 注意: UNIQUE 约束会自动创建索引，名称通常为约束名
  IF EXISTS (
    SELECT 1 FROM pg_indexes
    WHERE schemaname = 'public'
    AND tablename = 'mindmaps'
    AND indexname = 'unique_user_short_id'
  ) THEN
    -- 不能直接删除约束关联的索引，需要先删除约束
    -- 但我们不删除约束，而是让显式索引和约束索引共存
    -- PostgreSQL 会自动使用最优索引
    NULL;
  END IF;
END $$;

-- 创建显式命名的唯一索引
CREATE UNIQUE INDEX IF NOT EXISTS idx_mindmaps_user_short_id
  ON public.mindmaps(user_id, short_id);

-- 添加注释
COMMENT ON INDEX public.idx_mindmaps_user_short_id IS
  '复合唯一索引: 确保 short_id 在用户范围内唯一';

-- ============================================================================
-- 2. mindmap_nodes 表: 添加 idx_nodes_map_short_id 索引
-- ============================================================================

-- 创建显式命名的唯一索引
CREATE UNIQUE INDEX IF NOT EXISTS idx_nodes_map_short_id
  ON public.mindmap_nodes(mindmap_id, short_id);

-- 添加注释
COMMENT ON INDEX public.idx_nodes_map_short_id IS
  '复合唯一索引: 确保 short_id 在思维导图范围内唯一';

-- ============================================================================
-- 3. 可选: 删除 UNIQUE 约束（如果希望仅保留显式索引）
-- ============================================================================
-- 注意: 以下语句已注释，默认保留约束和显式索引共存
--        如果需要移除约束，取消注释以下语句

-- ALTER TABLE public.mindmaps
--   DROP CONSTRAINT IF EXISTS unique_user_short_id;

-- ALTER TABLE public.mindmap_nodes
--   DROP CONSTRAINT IF EXISTS unique_map_short_id;

-- ============================================================================
-- Migration 完成
-- ============================================================================
-- 变更说明:
-- 1. 添加了显式命名的唯一索引 idx_mindmaps_user_short_id
-- 2. 添加了显式命名的唯一索引 idx_nodes_map_short_id
-- 3. 保留了原有的 UNIQUE 约束（约束和索引可以共存）
-- 4. 与文档 id-design.md 中的索引定义保持一致
--
-- 性能影响:
-- - 约束和显式索引共存不会显著影响性能
-- - PostgreSQL 查询优化器会自动选择最优索引
-- - 如果希望移除约束，取消注释第 3 部分的语句（需要测试）
-- ============================================================================
