-- ============================================================================
-- User Profiles Constraints Update Migration
-- 修改 user_profiles 表的 username 约束
-- ============================================================================

-- ============================================================================
-- 注意事项
-- ============================================================================
-- 本 migration 会修改 username 的格式约束:
-- 旧约束: ^[a-zA-Z0-9_]+$ (大小写字母、数字、下划线)
-- 新约束: ^[a-z0-9]([a-z0-9-]{1,18}[a-z0-9])?$ (小写字母、数字、连字符)
--
-- 如果数据库中已有不符合新约束的数据, migration 会失败
-- 执行前请确保:
-- 1. 所有 username 都是小写
-- 2. 所有 username 使用连字符而不是下划线
-- 3. 所有 username 不以连字符开头或结尾
-- ============================================================================

-- ============================================================================
-- 1. 删除旧的 username 格式约束
-- ============================================================================

ALTER TABLE public.user_profiles
  DROP CONSTRAINT IF EXISTS username_format;

-- ============================================================================
-- 2. 添加新的 username 格式约束
-- ============================================================================

-- 约束: username 格式为小写字母、数字、连字符, 不能以连字符开头或结尾
ALTER TABLE public.user_profiles
  ADD CONSTRAINT username_format
  CHECK (username ~ '^[a-z0-9]([a-z0-9-]{1,18}[a-z0-9])?$');

-- 约束: username 必须是小写
ALTER TABLE public.user_profiles
  ADD CONSTRAINT username_lowercase
  CHECK (username = lower(username));

-- ============================================================================
-- 3. 更新注释
-- ============================================================================

COMMENT ON COLUMN public.user_profiles.username IS '用户名, 唯一标识, 3-20字符, 小写字母、数字、连字符, 不能以连字符开头或结尾, 用于URL: /@{username}';

-- ============================================================================
-- Migration 完成
-- ============================================================================
-- 新的 username 规则:
-- - 长度: 3-20 字符
-- - 字符集: 小写字母 (a-z), 数字 (0-9), 连字符 (-)
-- - 限制: 不能以连字符开头或结尾
-- - 强制: 必须小写
-- - 正则: ^[a-z0-9]([a-z0-9-]{1,18}[a-z0-9])?$
-- - 示例: colin, user-123, john-doe
-- ============================================================================
