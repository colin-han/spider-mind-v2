# Issue Fix Doc Command

**描述**: 通过修改文档来自动修复 issue 并生成修复报告

**重要说明**: 此命令用于**文档修复**，会修改 `docs/` 目录中的文档文件（如设计文档、规范文档、草稿等）。如果需要通过修改代码来修复问题，请使用 `/issue-fix-code` 命令。

**用法**:

- `/issue-fix-doc {issue_id}` - 使用推荐方案修复文档
- `/issue-fix-doc {issue_id} {方案编号}` - 使用 report 中指定方案修复文档（如：方案一、方案1、方案2）
- `/issue-fix-doc {issue_id} {自定义方案描述}` - 使用自定义方案修复文档

**参数**:

- `issue_id`: Issue 目录名（如：P0-003-mindmap-persistence-draft）
- `方案参数`: 可选，有三种形式：
  - **方案编号**: 如 "方案一"、"方案1"、"方案2" - 使用 report 中的对应方案
  - **自定义描述**: 详细的修复方案说明 - 不使用 report 中的任何方案，而是按照描述进行修复
  - **省略**: 使用 report 中的推荐方案

---

## 任务执行流程

你需要按照以下步骤自动化修复文档中的 issue：

### 1. 解析和验证参数

从用户输入中提取：

- `issue_id`: 必需参数
- `solution_param`: 可选参数，默认使用推荐方案

**参数解析示例**:

- `/issue-fix-doc P0-003-mindmap-persistence-draft`
  → issue_id = "P0-003-mindmap-persistence-draft", 使用推荐方案修复文档

- `/issue-fix-doc P0-003-mindmap-persistence-draft 方案一`
  → 使用 report 中的方案一修复文档

- `/issue-fix-doc P0-004-mindmap-persistence-draft 方案2`
  → 使用 report 中的方案二（方案2）修复文档

- `/issue-fix-doc P0-005-mindmap-persistence-draft 在草稿文档的 Schema 定义中添加缺失的字段`
  → 使用自定义方案描述修复文档

**参数识别逻辑**:

识别 `solution_param` 的类型：

1. **省略参数**: 如果没有提供 solution_param，使用推荐方案
2. **方案编号**: 如果包含"方案"关键词（如"方案一"、"方案1"、"方案二"），从 report 中查找对应方案
3. **自定义描述**: 如果不是方案编号格式，则视为自定义修复方案描述

**验证**:

- 检查 `.claude/issues/{issue_id}/` 目录是否存在
- 检查 `.claude/issues/{issue_id}/report.md` 文件是否存在
- 如果不存在，输出错误信息并终止

### 2. 读取 Issue Report

读取 `.claude/issues/{issue_id}/report.md` 文件，提取以下信息：

**必须提取的信息**:

- 问题描述和位置（通常指向文档文件）
- 所有修复方案（方案一、方案二、方案三等）
- 推荐方案（通常在 "## 推荐方案" 章节）
- 相关文档列表（在 "## 相关文档" 章节）
- 后续行动步骤（在 "## 后续行动步骤" 章节）

**解析修复方案**:

根据 `solution_param` 的类型选择修复方案：

1. **使用推荐方案**（`solution_param` 省略）:
   - 查找 "## 推荐方案" 章节
   - 提取推荐的方案编号（如："推荐使用方案一"）
   - 定位并提取该方案的完整内容

2. **使用指定方案**（`solution_param` 是方案编号）:
   - 识别方案编号（支持"方案一"、"方案1"、"方案二"、"方案2"等格式）
   - 在 report 中查找 "### 方案一" 或 "### 方案二" 等章节
   - 提取该方案的完整内容
   - 如果方案不存在，输出错误并列出可用方案

3. **使用自定义方案**（`solution_param` 是描述文本）:
   - 不查找 report 中的方案
   - 将 `solution_param` 作为修复指令
   - 结合问题描述和相关文档，理解并执行自定义方案

### 3. 读取相关文档

从 report 的 "## 相关文档" 章节提取所有文档路径，并读取这些文档：

**文档路径格式**:

```
- `docs/design/database-schema.md` - 第 136-165 行（mindmap_nodes 表定义）
- `docs/draft/mindmap-persistence-requirements.md` - 第 228-236、772 行（问题代码位置）
```

**读取策略**:

- 如果指定了行号范围，优先读取指定范围
- 如果没有行号，读取整个文件
- 将读取的内容作为上下文，用于理解问题和修复

### 4. 执行文档修复

根据选定的修复方案类型，执行文档修复：

#### 4.1 使用 Report 中的方案（推荐方案或指定方案）

**修复步骤**:

1. **理解修复方案**: 仔细阅读选定方案的文档修改示例和说明
2. **定位修改位置**: 根据 "问题代码位置" 定位需要修改的文档文件和行号
3. **执行修改**: 使用 Edit 工具进行文档修改
   - 尽量参考方案中提供的修改示例
   - 根据实际文档内容调整格式和表述
   - 可以根据实际情况优化方案中的实现细节
   - 如果方案内容与实际文档有出入，以实际文档为准进行合理调整
4. **验证修改**: 读取修改后的文档片段，确认修改正确

**注意事项**:

- 尽量按照选定方案的核心思路进行修复
- 方案提供的是参考实现，可以根据实际情况适当调整
- 保持文档风格与格式一致
- 如果方案中有多处修改点，确保核心修改都完成
- 可以在方案基础上进行合理优化或补充

#### 4.2 使用自定义方案描述

**修复步骤**:

1. **分析修复需求**:
   - 阅读问题描述，理解文档中的问题
   - 阅读自定义方案描述，理解用户的修复意图
   - 结合相关文档，理解上下文

2. **制定修复计划**:
   - 确定需要修改的文档文件和位置
   - 确定具体的修改内容
   - 如果方案描述不够详细，基于问题分析推断合理的修复方法
   - 确保修改计划符合文档规范

3. **确认修改计划**:
   - 输出计划并与用户确认
   - 如果用户确认，开始执行修改
   - 如果用户不确认，按照用户要求调整计划

4. **执行修改**:
   - 使用 Edit 工具进行文档修改
   - 确保修改符合自定义方案的意图
   - 保持文档风格和格式一致

5. **验证修改**:
   - 读取修改后的文档片段
   - 确认修改达到了自定义方案的目标
   - 确认没有引入新问题

**注意事项**:

- 自定义方案可能只是高层次描述，需要你根据问题分析填充细节
- 确保修复符合文档的写作规范和风格
- 如果自定义方案描述不清晰，优先选择最清晰、最准确的表述方式
- 在 fix-report.md 中详细说明你是如何理解和实现自定义方案的

### 5. 生成修复报告

修复完成后，创建修复报告文件 `.claude/issues/{issue_id}/fix-report.md`：

**报告格式**:

````markdown
# Issue 修复报告: {Issue 标题}

## 基本信息

- **Issue ID**: {issue_id}
- **修复日期**: {YYYY-MM-DD}
- **修复类型**: 文档修复
- **采用方案**: {选定的方案编号 或 "自定义方案"}
- **修复状态**: ✅ 已完成

## 修复概要

{简要描述修复了文档中的什么问题，使用了什么方案}

## 方案来源

{说明使用的是哪种方案}

**选项 1**: 使用 Report 推荐方案 - {方案编号}
**选项 2**: 使用 Report 指定方案 - {方案编号}
**选项 3**: 使用自定义方案

{如果是自定义方案，需要详细说明：}

- **用户提供的方案描述**: {原始描述}
- **方案理解**: {你如何理解这个方案}
- **实现思路**: {你计划如何实现}

## 修复详情

### 1. 文档修改列表

{列出所有修改的文档文件及其修改位置}

**修改文档**:

- `{file_path}` - 第 {line_range} 行

### 2. 具体修改内容

{对每个文档的修改进行详细说明}

#### 修改 1: {file_path}

**位置**: 第 {line_range} 行

**修改前**:

```markdown
{old_content}
```
````

**修改后**:

```markdown
{new_content}
```

**修改说明**: {解释为什么这样修改}

### 3. 修复效果

{列出修复后达到的效果}

- ✅ {效果1}
- ✅ {效果2}
- ✅ {效果3}

## 验证结果

{如果进行了验证，描述验证过程和结果}

- [ ] 文档内容准确
- [ ] 术语使用一致
- [ ] 格式规范统一
- [ ] 与实际实现一致

## 后续待办

{从 report 的"后续行动步骤"中提取，列出后续需要完成的事项}

- [ ] {待办事项1}
- [ ] {待办事项2}

---

**修复时间**: {timestamp}
**修复人**: Claude Code

````

### 6. 重命名 Issue 目录

修复完成并生成报告后，将 issue 目录标记为已完成：

**重命名操作**:
```bash
mv ".claude/issues/{issue_id}" ".claude/issues/✅ {issue_id}"
````

**验证**:

- 确认新目录存在
- 确认旧目录已删除
- 输出成功消息

### 7. 输出总结

向用户输出简洁的修复总结：

**输出格式**:

```
✅ Issue {issue_id} 文档修复完成

**修复类型**: 文档修复
**采用方案**: {方案编号}
**修改文档**: {文档数量} 个
**修复报告**: .claude/issues/✅ {issue_id}/fix-report.md

修复内容：
- {简要修复点1}
- {简要修复点2}

该 issue 已标记为已完成：.claude/issues/✅ {issue_id}/
```

## 错误处理

**如果遇到错误**:

1. **Issue 不存在**:

   ```
   ❌ 错误: Issue {issue_id} 不存在
   请检查 issue_id 是否正确，或使用以下命令查看可用的 issues:
   ls .claude/issues/
   ```

2. **方案编号无效**:

   ```
   ❌ 错误: 指定的方案 "{solution_id}" 在 report 中不存在
   可用方案: 方案一, 方案二, 方案三
   ```

3. **修复失败**:
   - 不要重命名目录
   - 在 fix-report.md 中标记失败状态
   - 输出详细错误信息
   - 提示用户手动检查

## 示例

**示例 1: 使用推荐方案修复文档**

```
用户输入: /issue-fix-doc P0-003-mindmap-persistence-draft

执行流程:
1. 读取 .claude/issues/P0-003-mindmap-persistence-draft/report.md
2. 发现推荐方案是"方案一"
3. 读取相关文档文件
4. 执行方案一的文档修复（在草稿文档中添加类型定义）
5. 生成 fix-report.md
6. 重命名目录为 .claude/issues/✅ P0-003-mindmap-persistence-draft
```

**示例 2: 指定方案编号修复文档**

```
用户输入: /issue-fix-doc P0-004-mindmap-persistence-draft 方案一

执行流程:
1. 读取 .claude/issues/P0-004-mindmap-persistence-draft/report.md
2. 识别"方案一"是方案编号
3. 在 report 中查找"方案一"的内容
4. 读取相关文档文件
5. 执行方案一的文档修复（补全 Schema 字段）
6. 生成 fix-report.md
7. 重命名目录为 .claude/issues/✅ P0-004-mindmap-persistence-draft
```

**示例 3: 使用自定义方案描述修复文档**

```
用户输入: /issue-fix-doc P0-005-mindmap-persistence-draft 在草稿文档的 mindmaps 表 Schema 定义中添加 description 字段

执行流程:
1. 读取 .claude/issues/P0-005-mindmap-persistence-draft/report.md
2. 识别这是自定义方案描述（不包含"方案"关键词）
3. 读取问题描述和相关文档
4. 理解自定义方案意图：在文档的 mindmaps 表定义中添加 description 字段
5. 定位需要修改的文档位置
6. 执行修改：在 Schema 定义中添加字段
7. 生成 fix-report.md（说明如何理解和实现自定义方案）
8. 重命名目录为 .claude/issues/✅ P0-005-mindmap-persistence-draft
```

## 注意事项

1. **精确匹配**: Edit 工具要求 old_string 精确匹配，确保从实际文档读取原始内容
2. **多处修改**: 如果一个方案需要修改多个位置，确保全部完成
3. **保持格式**: 保持文档格式和 Markdown 标记一致
4. **验证修复**: 修复后读取修改的部分，确认修改正确
5. **详细报告**: fix-report.md 应该包含足够的细节，便于后续审查

## 文档修复特殊考虑

**与代码修复的区别**:

- 文档修复注重**内容准确性**和**表述清晰度**
- 需要确保术语使用一致
- 需要保持文档结构和格式规范
- 需要验证修改后的文档是否与实际实现一致

**文档修复的重点**:

- ✅ 修正错误的描述或定义
- ✅ 补充缺失的信息
- ✅ 统一不一致的术语
- ✅ 改进不清晰的表述
- ✅ 更新过时的内容

## 工作原则

**对于 Report 中的方案**:

- 以方案的核心思路和目标为指导进行修复
- 方案提供的文档修改是参考，可以根据实际情况调整表述
- 可以在方案基础上进行合理优化或补充
- 如果方案内容与实际文档不匹配，灵活调整以适应实际情况
- 如果方案中有多处修改点，确保核心修改都完成

**对于自定义方案**:

- 仔细理解用户的修复意图
- 结合问题描述和相关文档，制定合理的修复计划
- 确保修复符合文档的写作规范
- 在 fix-report.md 中详细说明你是如何理解和实现方案的
- 如果描述不够清晰，选择最准确、最清晰的表述方式

**通用原则**:

- 修复的目标是改进文档质量，而不是机械复制方案内容
- 保持文档风格与项目规范一致
- 确保所有修改都完成后再生成报告
- 验证修复的准确性和清晰度
- 只有修复完全成功后才重命名目录
- 如果修复失败，保持目录原名，并在报告中说明失败原因
