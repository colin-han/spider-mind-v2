# é¢†åŸŸå±‚æ¶æ„è®¾è®¡

## å…ƒä¿¡æ¯

- åˆ›å»ºæ—¥æœŸ: 2025-11-06
- æœ€åæ›´æ–°: 2025-11-24
- ä½œè€…: Claude Code
- çŠ¶æ€: æ­£å¼ç‰ˆæœ¬
- ç›¸å…³æ–‡æ¡£:
  - [Command å±‚æ¶æ„è®¾è®¡](./command-layer-design.md)
  - [å‘½ä»¤å‚è€ƒæ‰‹å†Œ](./command-reference.md)
  - [AI åŠ©æ‰‹ç³»ç»Ÿè®¾è®¡](./ai-assistant-system-design.md)
  - [è§†å£ç®¡ç†è®¾è®¡](./viewport-management-design.md)
  - [æ•°æ®åº“è®¾è®¡](./database-schema.md)

## å…³é”®æ¦‚å¿µ

| æ¦‚å¿µ               | å®šä¹‰                                     | ç¤ºä¾‹/è¯´æ˜                                            |
| ------------------ | ---------------------------------------- | ---------------------------------------------------- |
| EditorAction       | åŸå­æ€§çŠ¶æ€å˜æ›´æ“ä½œï¼Œæ”¯æŒå¯é€†å’ŒæŒä¹…åŒ–     | AddNodeAction, RemoveNodeAction                      |
| CommandDefinition  | å‘½ä»¤å®šä¹‰ï¼Œå°è£…ä¸šåŠ¡é€»è¾‘å¹¶ç”Ÿæˆ Action åºåˆ— | node.addChild, navigation.selectParent               |
| ShortcutDefinition | å¿«æ·é”®å®šä¹‰ï¼Œå°†é”®ç›˜äº‹ä»¶æ˜ å°„åˆ°å‘½ä»¤         | Tab â†’ node.addChild                                  |
| HistoryManager     | æ’¤é”€/é‡åšæ ˆç®¡ç†å™¨ï¼Œè®°å½•æ“ä½œå†å²          | undo/redo æ ˆï¼Œæœ€å¤šä¿å­˜ 50 æ¡å†å²                     |
| CompositeCommand   | ç»„åˆå‘½ä»¤ï¼Œå°†å¤šä¸ªæ“ä½œæ‰“åŒ…ä¸ºä¸€ä¸ªå¯æ’¤é”€å•å…ƒ | AI æ‰¹é‡æ“ä½œï¼Œä¸€æ¬¡ undo æ’¤é”€æ‰€æœ‰æ“ä½œ                  |
| ActionSubscription | Action è®¢é˜…æœºåˆ¶ï¼Œå…è®¸æœåŠ¡å“åº”ç‰¹å®š Action | å¸ƒå±€æœåŠ¡è®¢é˜…èŠ‚ç‚¹å˜æ›´ Action è‡ªåŠ¨é‡æ–°è®¡ç®—å¸ƒå±€         |
| FocusedArea        | ç„¦ç‚¹åŒºåŸŸï¼Œæ ‡è¯†å½“å‰ç”¨æˆ·æ“ä½œçš„ UI åŒºåŸŸ     | outlineï¼ˆå¤§çº²è§†å›¾ï¼‰ã€graphï¼ˆå›¾å½¢è§†å›¾ï¼‰ã€noteï¼ˆç¬”è®°ï¼‰ |
| dirty flag         | è„æ ‡è®°ï¼Œæ ‡è¯†æ•°æ®æ˜¯å¦æœ‰æœªä¿å­˜çš„ä¿®æ”¹       | dirty=true è¡¨ç¤ºéœ€è¦åŒæ­¥åˆ°æœåŠ¡å™¨                      |
| applyToEditorState | Action çš„æ ¸å¿ƒæ–¹æ³•ï¼Œç”¨äºæ›´æ–°å†…å­˜çŠ¶æ€      | ä½¿ç”¨ Immer draft å®ç°ä¸å¯å˜æ›´æ–°                      |
| applyToIndexedDB   | Action çš„æŒä¹…åŒ–æ–¹æ³•ï¼Œç”¨äºæ›´æ–°æœ¬åœ°æ•°æ®åº“  | å¯é€‰å®ç°ï¼Œä»…æŒä¹…åŒ–æ•°æ®éœ€è¦                           |
| reverse()          | Action çš„é€†å‘æ–¹æ³•ï¼Œç”¨äºå®ç°æ’¤é”€          | AddNodeAction.reverse() â†’ RemoveNodeAction           |

## æ¦‚è¿°

é¢†åŸŸå±‚ï¼ˆDomain Layerï¼‰ä½äº `src/domain/` ç›®å½•ï¼Œå®ç°äº†æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ°æ•°æ®æŒä¹…åŒ–å½¢æˆå®Œæ•´çš„æ•°æ®æµã€‚æ”¯æŒå‘½ä»¤æ¨¡å¼ã€æ’¤é”€/é‡åšã€æ‰¹é‡æ“ä½œã€Action è®¢é˜…ç­‰é«˜çº§ç‰¹æ€§ã€‚

## ğŸ“– é˜…è¯»æŒ‡å—

### æ–‡æ¡£å®šä½

æœ¬æ–‡æ¡£æ˜¯**æ¶æ„æ€»è§ˆæ–‡æ¡£**ï¼Œæä¾›é¢†åŸŸå±‚çš„å…¨æ™¯è§†å›¾å’Œå„å±‚èŒè´£è¯´æ˜ã€‚å¦‚éœ€æ·±å…¥äº†è§£æŸä¸€å±‚çš„å®ç°ç»†èŠ‚ï¼Œè¯·å‚é˜…å¯¹åº”çš„è¯¦ç»†è®¾è®¡æ–‡æ¡£ã€‚

### æ–‡æ¡£ç±»å‹åŒºåˆ†

| æ–‡æ¡£ç±»å‹ | ç›®çš„                     | å†…å®¹ç‰¹ç‚¹                               | æœ¬æ–‡æ¡£å±æ€§ |
| -------- | ------------------------ | -------------------------------------- | ---------- |
| æ€»è§ˆæ–‡æ¡£ | ç†è§£æ•´ä½“æ¶æ„å’Œå„æ¨¡å—å…³ç³» | æ¦‚å¿µå®šä¹‰ã€å±‚çº§å…³ç³»ã€ç®€è¦è¯´æ˜ã€å¼•ç”¨é“¾æ¥ | âœ… æ€»è§ˆ    |
| è¯¦ç»†è®¾è®¡ | å®ç°å…·ä½“åŠŸèƒ½æˆ–å±‚çº§       | å®Œæ•´APIã€å®ç°ç»†èŠ‚ã€ä»£ç ç¤ºä¾‹ã€è®¾è®¡å†³ç­–  | âŒ         |
| å®æˆ˜æŒ‡å— | å­¦ä¹ å¦‚ä½•ä½¿ç”¨æˆ–æ‰©å±•ç³»ç»Ÿ   | ä½¿ç”¨æ¡ˆä¾‹ã€æœ€ä½³å®è·µã€å¸¸è§é—®é¢˜ã€è°ƒè¯•æŠ€å·§ | âŒ         |

### æ¨èé˜…è¯»è·¯å¾„

**ğŸ¯ å¿«é€Ÿç†è§£æ¶æ„**ï¼ˆ15åˆ†é’Ÿï¼‰

1. é˜…è¯»æœ¬æ–‡æ¡£çš„"åˆ†å±‚è®¾è®¡"å’Œ"æ•°æ®æµæ€»è§ˆ"ç« èŠ‚
2. ç†è§£ Command â†’ Action â†’ State çš„æ•°æ®æµ
3. äº†è§£å„å±‚çš„èŒè´£åˆ’åˆ†

**ğŸ“š æ·±å…¥å­¦ä¹ æŸä¸€å±‚**ï¼ˆ30-60åˆ†é’Ÿï¼‰

1. å…ˆé˜…è¯»æœ¬æ–‡æ¡£å¯¹åº”ç« èŠ‚ï¼Œäº†è§£è¯¥å±‚åœ¨æ•´ä½“æ¶æ„ä¸­çš„ä½ç½®
2. ç„¶åæŸ¥çœ‹è¯¦ç»†è®¾è®¡æ–‡æ¡£ï¼š
   - Commandå±‚ â†’ [Command å±‚æ¶æ„è®¾è®¡](./command-layer-design.md)
   - Actionå±‚ â†’ [Action å±‚æ¶æ„è®¾è®¡](./action-layer-design.md)
   - æŒä¹…åŒ–å±‚ â†’ [æ•°æ®åº“è®¾è®¡](./database-schema.md)

**ğŸ”§ å®ç°æ–°åŠŸèƒ½**ï¼ˆ1-2å°æ—¶ï¼‰

1. ç¡®å®šåŠŸèƒ½å±äºå“ªä¸€å±‚ï¼ˆé€šå¸¸ä»Commandå±‚å¼€å§‹ï¼‰
2. æŸ¥é˜…å¯¹åº”çš„è¯¦ç»†è®¾è®¡æ–‡æ¡£å’Œå‘½ä»¤å‚è€ƒæ‰‹å†Œ
3. å‚è€ƒå·²æœ‰å®ç°çš„æ¨¡å¼è¿›è¡Œå¼€å‘

### è¯¦ç»†è®¾è®¡æ–‡æ¡£ç´¢å¼•

| å±‚çº§      | è¯¦ç»†è®¾è®¡æ–‡æ¡£                                       | å†…å®¹                             |
| --------- | -------------------------------------------------- | -------------------------------- |
| Commandå±‚ | [Command å±‚æ¶æ„è®¾è®¡](./command-layer-design.md)    | å‘½ä»¤æ¨¡å¼ã€æ‰¹é‡æ“ä½œã€å‘½ä»¤æ³¨å†Œ     |
| Actionå±‚  | [Action å±‚æ¶æ„è®¾è®¡](./action-layer-design.md)      | Actionæ¥å£ã€è®¢é˜…æœºåˆ¶ã€æŒä¹…åŒ–é€»è¾‘ |
| æŒä¹…åŒ–å±‚  | [æ•°æ®åº“è®¾è®¡](./database-schema.md)                 | Schemaå®šä¹‰ã€åŒæ­¥æµç¨‹ã€å†²çªè§£å†³   |
| å¿«æ·é”®    | [å‘½ä»¤å‚è€ƒæ‰‹å†Œ](./command-reference.md)             | æ‰€æœ‰å‘½ä»¤åˆ—è¡¨ã€å¿«æ·é”®ç»‘å®š         |
| IDæœºåˆ¶    | [ID è®¾è®¡è§„èŒƒ](./id-design.md)                      | UUIDã€short_idç”Ÿæˆè§„åˆ™           |
| è§†å£ç®¡ç†  | [è§†å£ç®¡ç†è®¾è®¡](./viewport-management-design.md)    | åæ ‡ç³»ç»Ÿã€è§†å£åŒæ­¥ã€ç¼©æ”¾å¹³ç§»å‘½ä»¤ |
| èŠ‚ç‚¹å¸ƒå±€  | [èŠ‚ç‚¹å¸ƒå±€å¼•æ“è®¾è®¡](./node-layout-engine-design.md) | Dagreç®—æ³•ã€å¸ƒå±€æœåŠ¡ã€å°ºå¯¸ç¼“å­˜    |
| AIåŠ©æ‰‹    | [AI åŠ©æ‰‹ç³»ç»Ÿè®¾è®¡](./ai-assistant-system-design.md) | å¯¹è¯æŒä¹…åŒ–ã€æ“ä½œæ‰§è¡Œã€å‚æ•°è½¬æ¢   |

---

## åˆ†å±‚è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·äº¤äº’å±‚                              â”‚
â”‚              (UI Components, Event Handlers)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å¿«æ·é”®å±‚ (Shortcut)                      â”‚
â”‚   ShortcutManager + ShortcutRegister                    â”‚
â”‚   - ç›‘å¬é”®ç›˜äº‹ä»¶                                          â”‚
â”‚   - æ¡ä»¶åˆ¤æ–­ (when)                                       â”‚
â”‚   - æ˜ å°„åˆ°å‘½ä»¤                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‘½ä»¤å±‚ (Command)                        â”‚
â”‚   CommandManager + CommandRegistry                      â”‚
â”‚   - å‘½ä»¤å®šä¹‰æ³¨å†Œ                                          â”‚
â”‚   - æ¡ä»¶æ£€æŸ¥ (when)                                       â”‚
â”‚   - ä¸šåŠ¡é€»è¾‘ç¼–æ’                                          â”‚
â”‚   - ç”Ÿæˆ Action åºåˆ—                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åŠ¨ä½œå±‚ (Action)                         â”‚
â”‚   EditorAction æ¥å£å®ç°                                  â”‚
â”‚   - åŸå­æ€§çŠ¶æ€å˜æ›´                                        â”‚
â”‚   - å¯é€†æ“ä½œ (reverse)                                    â”‚
â”‚   - åŒå±‚æ›´æ–°é€»è¾‘                                          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                          â”‚
      â†“                                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çŠ¶æ€å±‚ (EditorState)â”‚              â”‚  å†å²å±‚ (History)    â”‚
â”‚  Zustand + Immer     â”‚              â”‚  HistoryManager     â”‚
â”‚  - å†…å­˜å¿«é€Ÿå“åº”      â”‚              â”‚  - æ’¤é”€æ ˆ           â”‚
â”‚  - Map/Set ä¼˜åŒ–      â”‚              â”‚  - é‡åšæ ˆ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  - ç‰ˆæœ¬ç®¡ç†         â”‚
          â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æŒä¹…åŒ–å±‚ (Persistence)                   â”‚
â”‚  IndexedDB (idb)                                        â”‚
â”‚  - æœ¬åœ°ç¼“å­˜                                              â”‚
â”‚  - è„æ ‡è®° (dirty flag)                                   â”‚
â”‚  - æ‰¹é‡åŒæ­¥                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å™¨å±‚ (Server)                       â”‚
â”‚  Supabase REST API                                      â”‚
â”‚  - äº‘ç«¯å­˜å‚¨                                              â”‚
â”‚  - å†²çªæ£€æµ‹                                              â”‚
â”‚  - ç‰ˆæœ¬æ§åˆ¶                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å„å±‚èŒè´£è¯¦è§£

### 1. å¿«æ·é”®å±‚ (Shortcut Layer)

**ä½ç½®**: `src/domain/shortcuts/`, `shortcut-manager.ts`, `shortcut-register.ts`

**èŒè´£**:

- ç›‘å¬ç”¨æˆ·é”®ç›˜è¾“å…¥
- æ ¹æ®å½“å‰çŠ¶æ€æ¡ä»¶åˆ¤æ–­æ˜¯å¦æ¿€æ´»
- æ˜ å°„å¿«æ·é”®åˆ°å‘½ä»¤ ID
- å¤„ç†å¹³å°å·®å¼‚ (Cmd on Mac, Ctrl on Windows)

**æ ¸å¿ƒç»„ä»¶**:

- `ShortcutManager`: é”®ç›˜äº‹ä»¶å¤„ç†å™¨
- `ShortcutRegister`: å¿«æ·é”®æ³¨å†Œè¡¨
- `ShortcutDefinition`: å¿«æ·é”®å®šä¹‰æ¥å£

**æ•°æ®æµ**:

```
KeyboardEvent â†’ ShortcutManager.handleKeydown()
              â†’ æŸ¥æ‰¾åŒ¹é…çš„ ShortcutDefinition
              â†’ æ£€æŸ¥ when() æ¡ä»¶
              â†’ è¿”å› { commandId, params }
              â†’ è°ƒç”¨ CommandManager.execute()
```

**è®¾è®¡ç‰¹ç‚¹**:

- âœ… ä¸€ä¸ªå¿«æ·é”®å¯ä»¥ç»‘å®šå¤šä¸ªå‘½ä»¤ï¼ˆé€šè¿‡ `when()` æ¡ä»¶é€‰æ‹©ï¼‰
- âœ… æ”¯æŒç»„åˆé”®å’Œä¿®é¥°é”®
- âœ… è‡ªåŠ¨ preventDefault() é˜»æ­¢é»˜è®¤è¡Œä¸º
- âŒ ä¸å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ˆä»…è´Ÿè´£æ˜ å°„ï¼‰

---

### 2. å‘½ä»¤å±‚ (Command Layer)

**ä½ç½®**: `src/domain/commands/`, `command-manager.ts`, `command-registry.ts`

**èŒè´£**: å®šä¹‰æ‰€æœ‰ä¸šåŠ¡æ“ä½œ,å°è£…ä¸šåŠ¡é€»è¾‘å’Œå‚æ•°éªŒè¯,ç”Ÿæˆ Action åºåˆ—,å†³å®šæ˜¯å¦å¯æ’¤é”€ã€‚

**å‘½ä»¤åˆ†ç±»**: Node Commands (10ä¸ª)ã€Navigation Commands (7ä¸ª)ã€View Commands (9ä¸ª)ã€Global Commands (5ä¸ª)ã€AI Commands (1ä¸ª)ã€Composite Commands (åŠ¨æ€)ã€‚

**è¯¦ç»†è®¾è®¡**: å‚è§ [Command å±‚æ¶æ„è®¾è®¡](./command-layer-design.md)

---

### 3. åŠ¨ä½œå±‚ (Action Layer)

**ä½ç½®**: `src/domain/actions/`

**èŒè´£**: å®šä¹‰åŸå­æ€§çŠ¶æ€å˜æ›´æ“ä½œ,å®ç°åŒå±‚æ›´æ–°ï¼ˆå†…å­˜ + æ•°æ®åº“ï¼‰,æä¾›å¯é€†æ“ä½œï¼ˆundo/redoï¼‰,ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

**Action åˆ†ç±»**:

- **æŒä¹…åŒ– Action**: AddNodeActionã€RemoveNodeActionã€UpdateNodeActionã€AddAIMessageActionã€UpdateAIMessageMetadataAction
- **éæŒä¹…åŒ– Action**: SetCurrentNodeActionã€CollapseNodeActionã€ExpandNodeActionã€SetViewportActionã€SetFocusedAreaAction

**è¯¦ç»†è®¾è®¡**: å‚è§ [Action å±‚æ¶æ„è®¾è®¡](./action-layer-design.md)

---

### 4. æ‰©å±•æœºåˆ¶

#### 4.1 CompositeCommandï¼ˆç»„åˆå‘½ä»¤ï¼‰

**ä½ç½®**: `src/domain/commands/composite/`

**èŒè´£**:

- å°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…ä¸ºä¸€ä¸ªå¯æ’¤é”€å•å…ƒ
- ä¿è¯åŸå­æ€§ï¼ˆå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥ï¼‰
- ç®€åŒ–æ‰¹é‡æ“ä½œçš„æ’¤é”€é€»è¾‘

**ä½¿ç”¨åœºæ™¯**:

- AI æ‰¹é‡æ“ä½œï¼šç”¨æˆ·ä¸€æ¬¡æ¥å—å¤šä¸ª AI å»ºè®®
- å¤æ‚ç¼–è¾‘ï¼šä¸€ä¸ªç”¨æˆ·æ“ä½œæ¶‰åŠå¤šä¸ªèŠ‚ç‚¹ä¿®æ”¹
- æ‰¹é‡å¯¼å…¥ï¼šå¯¼å…¥å¤–éƒ¨æ•°æ®åˆ›å»ºå¤šä¸ªèŠ‚ç‚¹

**æ ¸å¿ƒæ¥å£**:

```typescript
createCompositeCommand(
  description: string,
  commands: Array<{ commandId: string; params: unknown[] }>
): CommandDefinition
```

**ç‰¹ç‚¹**:

- âœ… ä¸€æ¬¡ undo æ’¤é”€æ‰€æœ‰æ“ä½œ
- âœ… ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½ä¼šå›æ»šå·²æ‰§è¡Œçš„éƒ¨åˆ†
- âœ… æ”¯æŒåµŒå¥—ï¼ˆCompositeCommand å¯ä»¥åŒ…å«å…¶ä»– CompositeCommandï¼‰
- âš ï¸ åªæ”¯æŒ undoable å‘½ä»¤ï¼ˆnon-undoable å‘½ä»¤ä¸èƒ½æ’¤é”€ï¼‰

**è¯¦ç»†è®¾è®¡**: å‚è§ [Command å±‚æ¶æ„è®¾è®¡ - æ‰¹é‡æ“ä½œç« èŠ‚](./command-layer-design.md#æ‰¹é‡æ“ä½œ---compositecommand)

#### 4.2 ActionSubscriptionï¼ˆAction è®¢é˜…ï¼‰

**ä½ç½®**: `src/domain/action-subscription-manager.ts`

**èŒè´£**: å…è®¸æœåŠ¡è®¢é˜…ç‰¹å®šç±»å‹çš„ Action,åœ¨ Action æ‰§è¡Œåè‡ªåŠ¨è§¦å‘å›è°ƒ,å®ç°åŒå±‚è®¢é˜…ï¼ˆSync + Asyncï¼‰å’Œåå¤„ç†æœºåˆ¶ã€‚

**è®¢é˜…ç±»å‹**: Sync è®¢é˜…ï¼ˆå¿«é€Ÿé¢„æµ‹ï¼‰ã€Post-Sync åå¤„ç†ï¼ˆæ‰¹é‡é©±åŠ¨ï¼‰ã€Async è®¢é˜…ï¼ˆç²¾ç¡®æµ‹é‡ï¼‰ã€Post-Async åå¤„ç†ï¼ˆæ‰¹é‡æ›´æ–°ï¼‰ã€‚

**è¯¦ç»†è®¾è®¡**: å‚è§ [Action å±‚æ¶æ„è®¾è®¡](./action-layer-design.md)

#### 4.3 FocusedAreaï¼ˆç„¦ç‚¹åŒºåŸŸï¼‰

**ä½ç½®**: `src/domain/focused-area-registry.ts`, `src/domain/focused-area.types.ts`

**èŒè´£**:

- è·Ÿè¸ªå½“å‰ç”¨æˆ·ç„¦ç‚¹åœ¨å“ªä¸ª UI åŒºåŸŸ
- æ ¹æ®ç„¦ç‚¹åŒºåŸŸè¿‡æ»¤å¯ç”¨å‘½ä»¤å’Œå¿«æ·é”®
- å®ç°ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„å‘½ä»¤æ‰§è¡Œ

**ç„¦ç‚¹åŒºåŸŸç±»å‹**:

```typescript
type FocusedArea =
  | "outline" // å¤§çº²è§†å›¾ï¼ˆå·¦ä¾§é¢æ¿ï¼‰
  | "graph" // å›¾å½¢è§†å›¾ï¼ˆä¸­é—´ç”»å¸ƒï¼‰
  | "note" // ç¬”è®°ç¼–è¾‘å™¨ï¼ˆå³ä¾§é¢æ¿ï¼‰
  | "ai-chat" // AI èŠå¤©é¢æ¿
  | "none"; // æ— ç„¦ç‚¹
```

**åº”ç”¨**:

- å‘½ä»¤å’Œå¿«æ·é”®çš„ `when()` æ¡ä»¶å¯ä»¥æ£€æŸ¥ `focusedArea`
- ä¾‹å¦‚ï¼š`Tab` é”®åœ¨ `outline` ä¸­æ·»åŠ å­èŠ‚ç‚¹ï¼Œåœ¨ `note` ä¸­æ’å…¥åˆ¶è¡¨ç¬¦
- é¿å…å¿«æ·é”®å†²çª

**ç‰¹ç‚¹**:

- âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼ˆä¸åŒåŒºåŸŸä¸åŒè¡Œä¸ºï¼‰
- âœ… è‡ªåŠ¨åˆ‡æ¢ï¼ˆç”¨æˆ·ç‚¹å‡»ä¸åŒåŒºåŸŸæ—¶è‡ªåŠ¨æ›´æ–°ï¼‰
- âœ… æŒä¹…åŒ–çŠ¶æ€ï¼ˆä¿å­˜åœ¨ EditorState ä¸­ï¼‰

---

### 5. çŠ¶æ€å±‚ (State Layer)

**ä½ç½®**: `mindmap-store.ts`, `mindmap-store.types.ts`

**èŒè´£**:

- å…¨å±€çŠ¶æ€å®¹å™¨ï¼ˆZustandï¼‰
- åè°ƒå„ä¸ªç®¡ç†å™¨ï¼ˆCommand, Shortcut, Historyï¼‰
- æä¾›ç»Ÿä¸€çš„çŠ¶æ€è®¿é—®æ¥å£
- ç®¡ç†ç¼–è¾‘å™¨ç”Ÿå‘½å‘¨æœŸ

**æ ¸å¿ƒæ•°æ®ç»“æ„**:

```typescript
EditorState {
  // æ ¸å¿ƒæ•°æ® (æŒä¹…åŒ–)
  currentMindmap: Mindmap
  nodes: Map<short_id, MindmapNode>   // O(1) æŸ¥è¯¢ï¼Œä½¿ç”¨ short_id ä½œä¸ºé”®

  // UI çŠ¶æ€ (éæŒä¹…åŒ–)
  collapsedNodes: Set<short_id>       // O(1) æŸ¥è¯¢
  focusedArea: FocusedArea
  currentNode: string

  // å…ƒæ•°æ®
  isLoading: boolean
  isSaved: boolean
  version: number                      // é€’å¢ç‰ˆæœ¬å·
}
```

**ID è®¾è®¡**: ç³»ç»Ÿä½¿ç”¨ UUID ä½œä¸ºä¸»é”®ï¼Œshort_idï¼ˆ6å­—ç¬¦ base36ï¼‰ä½œä¸ºç”¨æˆ·å‹å¥½æ ‡è¯†ç¬¦ã€‚è¯¦è§ [ID è®¾è®¡è§„èŒƒ](./id-design.md)ã€‚

**æ€§èƒ½ä¼˜åŒ–**:

- ä½¿ç”¨ `Map` è€Œéæ•°ç»„ï¼ŒèŠ‚ç‚¹æŸ¥è¯¢ä» O(n) é™è‡³ O(1)
- ä½¿ç”¨ `Set` å­˜å‚¨æŠ˜å çŠ¶æ€ï¼Œæ£€æŸ¥ä» O(n) é™è‡³ O(1)
- Immer å®ç°ç»“æ„å…±äº«ï¼Œé¿å…ä¸å¿…è¦çš„æ‹·è´
- é€‰æ‹©æ€§ re-renderï¼ˆZustand æµ…æ¯”è¾ƒï¼‰

**æ•°æ®æµ**:

```
openMindmap(mindmapId)
  â†’ ä» IndexedDB åŠ è½½æ•°æ®
  â†’ åˆå§‹åŒ– EditorState
  â†’ åˆå§‹åŒ– CommandManager, ShortcutManager, HistoryManager
  â†’ è®¾ç½® isLoading = false

acceptActions(actions[])
  â†’ Immer produce() æ›´æ–°å†…å­˜
  â†’ é€’å¢ version
  â†’ IndexedDB æ‰¹é‡æ›´æ–°
  â†’ æ ‡è®° isSaved = false
```

---

### 6. å†å²å±‚ (History Layer)

**ä½ç½®**: `history-manager.ts`

**èŒè´£**:

- ç®¡ç†æ’¤é”€/é‡åšæ ˆ
- è®°å½•æ“ä½œæè¿°
- å®ç°ç‰ˆæœ¬å›é€€
- é™åˆ¶å†å²é•¿åº¦

**æ ¸å¿ƒæ•°æ®ç»“æ„**:

```typescript
HistoryManager {
  undoStack: HistoryEntry[]      // æ’¤é”€æ ˆ
  redoStack: HistoryEntry[]      // é‡åšæ ˆ
  maxHistorySize: 50             // æœ€å¤§å†å²æ•°é‡
}

HistoryEntry {
  actions: EditorAction[]        // åŠ¨ä½œåºåˆ—
  description: string            // æ“ä½œæè¿°
  version: number                // çŠ¶æ€ç‰ˆæœ¬å·
}
```

**æ•°æ®æµ**:

```
HistoryManager.execute(actions, description)
  â†’ æ¸…ç©º redoStack
  â†’ æ‰§è¡Œ store.acceptActions(actions)
  â†’ æ¨å…¥ undoStack
  â†’ é™åˆ¶æ ˆå¤§å°

HistoryManager.undo()
  â†’ ä» undoStack å¼¹å‡º entry
  â†’ å¯¹æ¯ä¸ª action è°ƒç”¨ reverse()
  â†’ æ‰§è¡Œåå‘ actions
  â†’ æ¨å…¥ redoStack

HistoryManager.redo()
  â†’ ä» redoStack å¼¹å‡º entry
  â†’ é‡æ–°æ‰§è¡Œ actions
  â†’ æ¨å…¥ undoStack
```

**è®¾è®¡ç‰¹ç‚¹**:

- âœ… æ”¯æŒæ‰¹é‡æ“ä½œï¼ˆä¸€æ¬¡ undo æ’¤é”€å¤šä¸ª Actionï¼‰
- âœ… è‡ªåŠ¨ç”Ÿæˆæè¿°ï¼ˆé€šè¿‡ Command.getDescription()ï¼‰
- âœ… ç‰ˆæœ¬å·è¿½è¸ªï¼ˆç”¨äºè°ƒè¯•å’Œæ—¥å¿—ï¼‰
- âš ï¸ ä»…æ”¯æŒçº¿æ€§å†å²ï¼ˆä¸æ”¯æŒåˆ†æ”¯ï¼‰

---

### 7. æŒä¹…åŒ–å±‚ (Persistence Layer)

**ä½ç½®**: `src/lib/db/schema.ts`, `src/lib/sync/sync-manager.ts`

**èŒè´£**: æœ¬åœ°æ•°æ®ç¼“å­˜ï¼ˆIndexedDBï¼‰ã€è„æ ‡è®°ç®¡ç†ã€æ‰¹é‡åŒæ­¥åˆ°æœåŠ¡å™¨ã€å†²çªæ£€æµ‹å’Œè§£å†³ã€‚

**æ ¸å¿ƒæœºåˆ¶**: ä¸‰å±‚å­˜å‚¨æ¶æ„ï¼ˆå†…å­˜ Store â†’ IndexedDB â†’ Supabaseï¼‰ï¼Œç¦»çº¿ä¼˜å…ˆï¼Œå¢é‡åŒæ­¥ï¼Œä½¿ç”¨ dirty flag è¿½è¸ªæœªä¿å­˜ä¿®æ”¹ï¼ŒåŸºäºæ—¶é—´æˆ³çš„å†²çªæ£€æµ‹ã€‚

**è¯¦ç»†è®¾è®¡**:

- [æŒä¹…åŒ–ä¸­é—´ä»¶è®¾è®¡](./persistence-middleware-design.md) - ä¸‰å±‚å­˜å‚¨ã€Dirty Flagã€å†²çªæ£€æµ‹ã€æ€§èƒ½ä¼˜åŒ–
- [æ•°æ®åº“è®¾è®¡](./database-schema.md) - Schema å®šä¹‰ã€ç´¢å¼•ã€è§¦å‘å™¨ã€RLS ç­–ç•¥

---

## æ•°æ®æµæ€»è§ˆ

### æ ¸å¿ƒæ•°æ®æµå›¾

ä»¥ä¸‹æ˜¯ Command â†’ Action â†’ State çš„æ ¸å¿ƒæ•°æ®æµç¨‹ï¼ˆé€‚ç”¨äºæ‰€æœ‰å±‚çº§ï¼‰ï¼Œå±•ç¤ºäº†ä¸€ä¸ªå®Œæ•´æ“ä½œä»è§¦å‘åˆ°æŒä¹…åŒ–çš„å…¨è¿‡ç¨‹ï¼š

```mermaid
graph TD
    A[ç”¨æˆ·è§¦å‘<br/>å¿«æ·é”®/æŒ‰é’®/å‘½ä»¤] --> B[ShortcutManager<br/>é”®ç›˜äº‹ä»¶æ˜ å°„]
    B --> C[CommandManager<br/>executeå‘½ä»¤]

    C --> D{æ£€æŸ¥whenæ¡ä»¶}
    D -->|æ¡ä»¶ä¸æ»¡è¶³| E[é™é»˜è¿”å›]
    D -->|æ¡ä»¶æ»¡è¶³| F[Command.handler<br/>ä¸šåŠ¡é€»è¾‘ç¼–æ’]

    F --> G[ç”ŸæˆActionåºåˆ—<br/>AddNodeAction, UpdateNodeAction...]

    G --> H[HistoryManager<br/>è®°å½•åˆ°undoStack]
    H --> I[EditorState<br/>acceptActions]

    I --> J[Immer produce<br/>æ›´æ–°å†…å­˜çŠ¶æ€]
    I --> K[applyToIndexedDB<br/>æŒä¹…åŒ–åˆ°æœ¬åœ°]

    J --> L[Reacté‡æ¸²æŸ“UI<br/>Zustandé€šçŸ¥è®¢é˜…è€…]
    K --> M[æ ‡è®°dirty=true<br/>ç­‰å¾…åŒæ­¥]

    M --> N{ç”¨æˆ·ç‚¹å‡»ä¿å­˜?}
    N -->|æ˜¯| O[SyncManager<br/>åŒæ­¥åˆ°Supabase]
    O --> P[æ¸…é™¤dirtyæ ‡è®°<br/>æ›´æ–°serveræ—¶é—´æˆ³]

    style A fill:#e1f5fe
    style C fill:#fff9c4
    style F fill:#fff9c4
    style G fill:#c8e6c9
    style I fill:#f8bbd0
    style J fill:#f8bbd0
    style K fill:#d1c4e9
    style O fill:#d1c4e9

    classDef userLayer fill:#e1f5fe,stroke:#01579b
    classDef commandLayer fill:#fff9c4,stroke:#f57f17
    classDef actionLayer fill:#c8e6c9,stroke:#2e7d32
    classDef stateLayer fill:#f8bbd0,stroke:#c2185b
    classDef persistLayer fill:#d1c4e9,stroke:#4a148c
```

**å›¾ä¾‹è¯´æ˜**:

- ğŸ”µ è“è‰²ï¼šç”¨æˆ·äº¤äº’å±‚
- ğŸŸ¡ é»„è‰²ï¼šCommandå±‚
- ğŸŸ¢ ç»¿è‰²ï¼šActionå±‚
- ğŸ”´ ç²‰è‰²ï¼šStateå±‚ï¼ˆå†…å­˜ï¼‰
- ğŸŸ£ ç´«è‰²ï¼šæŒä¹…åŒ–å±‚ï¼ˆæ•°æ®åº“ï¼‰

**ä¸åŒè§†è§’çš„ç†è§£**ï¼š

- **Commandå±‚è§†è§’**ï¼šå…³æ³¨å¦‚ä½•ä»å‘½ä»¤IDåˆ°Actionåºåˆ—çš„è½¬æ¢ï¼ˆèŠ‚ç‚¹Câ†’Fâ†’Gï¼‰
- **Actionå±‚è§†è§’**ï¼šå…³æ³¨Actionå¦‚ä½•æ›´æ–°å†…å­˜å’Œæ•°æ®åº“ï¼ˆèŠ‚ç‚¹Gâ†’Iâ†’J+Kï¼‰
- **Stateå±‚è§†è§’**ï¼šå…³æ³¨å¦‚ä½•æ¥æ”¶Actionså¹¶è§¦å‘Reactæ›´æ–°ï¼ˆèŠ‚ç‚¹Iâ†’Jâ†’Lï¼‰

---

### å®Œæ•´çš„æ“ä½œé“¾è·¯

```
ç”¨æˆ·æŒ‰ä¸‹ Tab é”®
  â†“
ShortcutManager æ•è·äº‹ä»¶
  â†“
æŸ¥æ‰¾ "tab" â†’ { commandId: "node.addChild", params: [] }
  â†“
CommandManager.execute("node.addChild")
  â†“
æ£€æŸ¥ when() â†’ éœ€è¦é€‰ä¸­èŠ‚ç‚¹ âœ…
  â†“
è°ƒç”¨ addChild.handler(store)
  â†“
ä¸šåŠ¡é€»è¾‘: åˆ›å»ºæ–°èŠ‚ç‚¹ã€è®¡ç®— order_indexã€è°ƒæ•´å…¶ä»–èŠ‚ç‚¹
  â†“
è¿”å›: [
  new AddNodeAction(newNode),
  new SetCurrentNodeAction(oldId, newId),
  ...æ›´æ–°å…„å¼ŸèŠ‚ç‚¹çš„ UpdateNodeAction[]
]
  â†“
HistoryManager.execute(actions, "æ·»åŠ å­èŠ‚ç‚¹")
  â†“
store.acceptActions(actions)
  â†“
å¹¶è¡Œæ‰§è¡Œ:
  â”œâ”€ Immer produce() æ›´æ–°å†…å­˜çŠ¶æ€
  â”‚   â”œâ”€ nodes.set(newNode.short_id, newNode)
  â”‚   â”œâ”€ currentNode = newNode.short_id
  â”‚   â””â”€ version++
  â”‚   â†’ React é‡æ¸²æŸ“ UI
  â”‚
  â””â”€ IndexedDB äº‹åŠ¡
      â”œâ”€ db.put("mindmap_nodes", { ...newNode, dirty: true })
      â”œâ”€ db.put("mindmap_nodes", { ...updatedNode, dirty: true })
      â””â”€ æäº¤äº‹åŠ¡
  â†“
æ ‡è®° isSaved = false (é¡¶éƒ¨æ˜¾ç¤º"æœªä¿å­˜"çŠ¶æ€)
  â†“
ç”¨æˆ·ç‚¹å‡»ä¿å­˜æŒ‰é’®
  â†“
SyncManager.syncMindmap()
  â†“
æ”¶é›†æ‰€æœ‰ dirty = true çš„æ•°æ®
  â†“
æ‰¹é‡ upsert åˆ° Supabase
  â†“
æ¸…é™¤ dirty æ ‡è®°, æ›´æ–° server_updated_at
  â†“
æ ‡è®° isSaved = true
```

---

## è®¾è®¡åŸåˆ™

### 1. å•å‘æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ â†’ Command â†’ Action â†’ State â†’ UI
```

- ä¸å…è®¸ UI ç›´æ¥ä¿®æ”¹çŠ¶æ€
- æ‰€æœ‰å˜æ›´é€šè¿‡ Action é€šé“
- ä¾¿äºè¿½è¸ªå’Œè°ƒè¯•

### 2. èŒè´£åˆ†ç¦»

| å±‚çº§     | èŒè´£     | ä¸åº”è¯¥åš       |
| -------- | -------- | -------------- |
| Shortcut | é”®ç›˜æ˜ å°„ | ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ |
| Command  | ä¸šåŠ¡ç¼–æ’ | ä¸ç›´æ¥ä¿®æ”¹çŠ¶æ€ |
| Action   | çŠ¶æ€å˜æ›´ | ä¸åŒ…å«å¤æ‚è®¡ç®— |
| State    | æ•°æ®å­˜å‚¨ | ä¸åŒ…å«ä¸šåŠ¡è§„åˆ™ |

### 3. å¯æµ‹è¯•æ€§

- Command æ˜¯çº¯å‡½æ•°ï¼ˆç»™å®šè¾“å…¥ â†’ ç¡®å®šè¾“å‡ºï¼‰
- Action æ˜¯å¯é‡æ”¾çš„ï¼ˆå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ï¼‰
- çŠ¶æ€æ˜¯ä¸å¯å˜çš„ï¼ˆImmer ä¿è¯ï¼‰

### 4. å¯æ‰©å±•æ€§

- æ’ä»¶å¼æ³¨å†Œï¼ˆCommand/Shortcut Registerï¼‰
- æ¥å£é©±åŠ¨ï¼ˆEditorAction/CommandDefinitionï¼‰
- å¼€é—­åŸåˆ™ï¼ˆæ–°å¢åŠŸèƒ½æ— éœ€ä¿®æ”¹æ ¸å¿ƒï¼‰

---

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **æ–°å¢åŠŸèƒ½ä» Command å¼€å§‹**
   - å…ˆå®šä¹‰å‘½ä»¤æ¥å£å’Œä¸šåŠ¡é€»è¾‘
   - å†å®ç° Actionï¼ˆå¦‚éœ€æŒä¹…åŒ–ï¼‰
   - æœ€åç»‘å®šå¿«æ·é”®ï¼ˆå¦‚éœ€è¦ï¼‰

2. **ä¿æŒ Action ç®€å•**
   - ä¸€ä¸ª Action åªåšä¸€ä»¶äº‹
   - å¤æ‚æ“ä½œç”¨å¤šä¸ª Action ç»„åˆ

3. **ä½¿ç”¨å·¥å…·å‡½æ•°**
   - `editor-utils.ts` æä¾›é€šç”¨æ ‘æ“ä½œ
   - ä¸è¦åœ¨ Command ä¸­é‡å¤å®ç°

4. **å–„ç”¨æ¡ä»¶æ‰§è¡Œ**
   - Command çš„ `when()` æ£€æŸ¥å‰ç½®æ¡ä»¶
   - Shortcut çš„ `when()` æ£€æŸ¥ä¸Šä¸‹æ–‡

### âŒ é¿å…åšæ³•

1. **ä¸è¦åœ¨ UI ä¸­ç›´æ¥ä¿®æ”¹ store**

   ```typescript
   // âŒ é”™è¯¯
   store.setState({ currentNode: "abc123" });

   // âœ… æ­£ç¡®
   await executeCommand("navigation.setCurrentNode", ["abc123"]);
   ```

2. **ä¸è¦åœ¨ Action ä¸­è°ƒç”¨å…¶ä»– Action**

   ```typescript
   // âŒ é”™è¯¯
   applyToEditorState(draft) {
     new AddNodeAction(...).applyToEditorState(draft)
   }

   // âœ… æ­£ç¡®ï¼ˆåœ¨ Command å±‚ç»„åˆï¼‰
   handler(store) {
     return [
       new AddNodeAction(...),
       new UpdateNodeAction(...)
     ]
   }
   ```

3. **ä¸è¦åœ¨ Command ä¸­è®¿é—® IndexedDB**

   ```typescript
   // âŒ é”™è¯¯
   async handler(store) {
     const db = await getDB()
     await db.put(...)
   }

   // âœ… æ­£ç¡®ï¼ˆé€šè¿‡ Action é—´æ¥æ“ä½œï¼‰
   handler(store) {
     return [new AddNodeAction(...)]  // Action ä¼šå¤„ç† IndexedDB
   }
   ```

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### æ€§èƒ½ä¼˜åŒ–

1. **è™šæ‹ŸåŒ–æ¸²æŸ“**
   - å¤§é‡èŠ‚ç‚¹æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
   - å½“å‰æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šæ¸²æŸ“

2. **å¢é‡æŒä¹…åŒ–**
   - å½“å‰æ¯ä¸ª Action éƒ½è§¦å‘ IndexedDB å†™å…¥
   - å¯ä»¥æ‰¹é‡å»¶è¿Ÿå†™å…¥ï¼ˆdebounceï¼‰

3. **å†…å­˜ç®¡ç†**
   - History æ ˆæ— é™å¢é•¿ä¼šå ç”¨å†…å­˜
   - è€ƒè™‘å‹ç¼©æ—§å†å²è®°å½•

### åŠŸèƒ½æ‰©å±•

1. **å®æ—¶ååŒ**
   - WebSocket æ¨é€æ›´æ–°
   - Operational Transform (OT) æˆ– CRDT

2. **æ’ä»¶ç³»ç»Ÿ**
   - å…è®¸ç¬¬ä¸‰æ–¹æ‰©å±•å‘½ä»¤
   - è‡ªå®šä¹‰ Action ç±»å‹

3. **ç¦»çº¿ç¼–è¾‘**
   - Service Worker ç¼“å­˜
   - æ–­çº¿ç»­ä¼ æœºåˆ¶

---

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆè¦åˆ† Command å’Œ Action ä¸¤å±‚ï¼Ÿ**

A:

- Command è´Ÿè´£ä¸šåŠ¡é€»è¾‘ç¼–æ’ï¼ˆå¯èƒ½éœ€è¦æŸ¥è¯¢ã€è®¡ç®—ã€éªŒè¯ï¼‰
- Action è´Ÿè´£çº¯ç²¹çš„çŠ¶æ€å˜æ›´ï¼ˆåŸå­æ€§ã€å¯é€†æ€§ï¼‰
- åˆ†ç¦»åæ›´å®¹æ˜“æµ‹è¯•å’Œç»´æŠ¤

**Q: ä»€ä¹ˆæ—¶å€™ Action éœ€è¦å®ç° applyToIndexedDBï¼Ÿ**

A: åªæœ‰éœ€è¦æŒä¹…åŒ–çš„æ•°æ®æ‰éœ€è¦ã€‚UI çŠ¶æ€ï¼ˆå¦‚ currentNode, focusedAreaï¼‰æ— éœ€æŒä¹…åŒ–ã€‚

**Q: undo/redo çš„æ€§èƒ½å¦‚ä½•ï¼Ÿ**

A: éå¸¸å¿«ã€‚å› ä¸º Action å·²ç»è®°å½•äº†æ‰€æœ‰å˜æ›´ç»†èŠ‚ï¼Œreverse() ç›´æ¥ç”Ÿæˆåå‘æ“ä½œï¼Œæ— éœ€é‡æ–°è®¡ç®—ã€‚

**Q: å¦‚ä½•è°ƒè¯•æ•°æ®æµï¼Ÿ**

A:

1. å¼€å¯ Zustand DevTools
2. åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ IndexedDB
3. åœ¨ Command handler ä¸­æ·»åŠ  console.log
4. æ£€æŸ¥ HistoryManager çš„æ ˆ

---

## ä¿®è®¢å†å²

| æ—¥æœŸ       | ç‰ˆæœ¬ | ä¿®æ”¹å†…å®¹                                                                                                        | ä½œè€…        |
| ---------- | ---- | --------------------------------------------------------------------------------------------------------------- | ----------- |
| 2025-11-24 | 1.1  | æ·»åŠ å…³é”®æ¦‚å¿µç« èŠ‚ï¼Œæ›´æ–°å‘½ä»¤å’Œ Action åˆ†ç±»ï¼Œæ–°å¢æ‰©å±•æœºåˆ¶ç« èŠ‚ï¼ˆCompositeCommandã€ActionSubscriptionã€FocusedAreaï¼‰ | Claude Code |
| 2025-11-06 | 1.0  | åˆå§‹ç‰ˆæœ¬ï¼Œæè¿°é¢†åŸŸå±‚æ•´ä½“æ¶æ„è®¾è®¡                                                                                | Claude Code |

## ç›¸å…³æ–‡æ¡£

- [Command å±‚æ¶æ„è®¾è®¡](./command-layer-design.md) - Command è¯¦ç»†è®¾è®¡ï¼ˆåŒ…å« CompositeCommand æ‰¹é‡æ“ä½œï¼‰
- [å‘½ä»¤å‚è€ƒæ‰‹å†Œ](./command-reference.md) - æ‰€æœ‰å‘½ä»¤åˆ—è¡¨å’Œå¿«æ·é”®
- [AI åŠ©æ‰‹ç³»ç»Ÿè®¾è®¡](./ai-assistant-system-design.md) - AI é›†æˆå’Œæ“ä½œæ‰§è¡Œ
- [è§†å£ç®¡ç†è®¾è®¡](./viewport-management-design.md) - è§†å£ç®¡ç†å’Œ Action è®¢é˜…
- [èŠ‚ç‚¹å¸ƒå±€å¼•æ“è®¾è®¡](./node-layout-engine-design.md) - å¸ƒå±€æœåŠ¡å’Œ Action è®¢é˜…
- [æ•°æ®åº“è®¾è®¡](./database-schema.md) - IndexedDB å’Œ Supabase è®¾è®¡

---

_æœ¬æ–‡æ¡£æè¿°äº†é¢†åŸŸå±‚çš„æ•´ä½“æ¶æ„è®¾è®¡ï¼Œå®šæœŸæ›´æ–°ä»¥ä¿æŒä¸å®ç°ä¸€è‡´ã€‚_
